---
layout: default
title: NFS安装小记
category: linux
---
今天打算捣鼓个NFS玩玩，感受一下远程共享的便捷
[鸟哥的私房菜-NFS篇](http://linux.vbird.org/linux_server/0330nfs.php#nfsserver_exports)
#安装并启用NFS程序
1. `yum install nfs-utils`,会自动将依赖的rpcbind程序也安装好
2. `service rpcbind start`,必须要先启动rpcbind
3. `service nfs start`,启动hfs进程

##配置NFS目录
`/etc/exports`记录了NFS对应的目录设置

    /home/wy hellfe.com(rw) localhost(rw)

这其中指定的是覆盖默认设置的设置，`/var/lib/nfs/etab`文件包含了实际的设置（包含默认设置）
最好将共享的文件所有者和用户组设置成nfsnobody:nfsnobody,这样就不怕权限问题无法修改
修改完该文件后，需要重启NFS服务(比较麻烦)或者`exportfs -arv`来生效

##server端测试状态
+ `showmount -e localhost`显示某主机上共享的目录资料
+ `showmount -a`显示本机连接的NFS

##配置防火墙
[主要参考这个](http://eduardo-lago.blogspot.com/2012/02/installing-nfs-on-centos-62.html)

防火墙需要打开以下端口：

1. TCP/UDP 111 - RPC 4.0 portmapper
2. TCP/UDP 2049 - NFSD (nfs server)
3. Portmap static ports, Various TCP/UDP ports defined in /etc/sysconfig/nfs file.

其中第三项通过在`/etc/sysconfig/nfs`里面设置，其实就是去掉注释就好：

    LOCKD_TCPPORT=32803
    LOCKD_UDPPORT=32769
    MOUNTD_PORT=892
    RQUOTAD_PORT=875
    STATD_PORT=662
    STATD_OUTGOING_PORT=2020

在防火墙规则正文中，加入如下条目:

    -A INPUT -s 0.0.0.0/0 -m state --state NEW -p udp --dport 111 -j ACCEPT
    -A INPUT -s 0.0.0.0/0 -m state --state NEW -p tcp --dport 111 -j ACCEPT
    -A INPUT -s 0.0.0.0/0 -m state --state NEW -p tcp --dport 2049 -j ACCEPT
    -A INPUT -s 0.0.0.0/0 -m state --state NEW -p tcp --dport 32803 -j ACCEPT
    -A INPUT -s 0.0.0.0/0 -m state --state NEW -p udp --dport 32769 -j ACCEPT
    -A INPUT -s 0.0.0.0/0 -m state --state NEW -p tcp --dport 892 -j ACCEPT
    -A INPUT -s 0.0.0.0/0 -m state --state NEW -p udp --dport 892 -j ACCEPT
    -A INPUT -s 0.0.0.0/0 -m state --state NEW -p tcp --dport 875 -j ACCEPT
    -A INPUT -s 0.0.0.0/0 -m state --state NEW -p udp --dport 875 -j ACCEPT
    -A INPUT -s 0.0.0.0/0 -m state --state NEW -p tcp --dport 662 -j ACCEPT
    -A INPUT -s 0.0.0.0/0 -m state --state NEW -p udp --dport 662 -j ACCEPT

##客户端挂载
客户端也需要安装并运行nfs程序，然后执行下述命令挂载即可：
`mount -t nfs hellofe.com:/tmp/test /tmp/remote`

#碰到的问题
##Stale NFS file handle 报错
client端mount上了server端的directory之后,server端将这个directory重新export或者
delete之后,就会报上述错误.[参考](http://sysunconfig.net/unixtips/stale_nfs.txt)  
解决方法: 重启客户端hfs进程`service hfs restart`

##操作挂载文件时提示 "Permission Denied"
原因:NFS共享的DIR所有者是root,而默认情况下,即使客户端使用root身份操作,也会被
root_squash自动设定成nfsnobody,指定no_root_squash属性就好

##mount.nfs: access denied by server while mounting
客户端在挂载的时候报该错，网上说需要设定共享DIR的insecure参数，允许客户端从大于
1024的tcp/ip端口连接服务器。也就是说默认的是secure参数，限制客户端只能从小于1024
的tcp/ip端口连接nfs服务器，而我的客户端在mount的时候，使用了大于1024的端口，自然
被服务器deny了，加了insecure之后OK了。

##挂载的文档没有权限操作
一般NFS的文件夹的所有者和最后连接的客户端的用户是不同的，这就导致了绝大多数情况下
直接mount NFS 文件夹之后没有写权限，需要进行用户映射。选项如下：  
+ all_squash 将远程访问的所有普通用户及所属组都映射为匿名用户或用户组（nfsnobody）
+ no_all_squash 与all_squash取反（默认设置）；
+ root_squash 将root用户及所属组都映射为匿名用户或用户组（默认设置）
+ no_root_squash 与rootsquash取反
+ anonuid=xxx 将远程访问的所有用户都映射为匿名用户，并指定该用户为本地用户（UID=xxx）
+ anongid=xxx 将远程访问的所有用户组都映射为匿名用户组账户，并指定该匿名用户组账户为
本地用户组账户（GID=xxx）

服务器上的账户对应的uid和gid分别是500，**设置all_squash参数**，去掉其他的squash
并设置好anonud=500和anongid=500就可以了。

##Fedora下面开机自启动问题
直接`systemctl enable nfs.service`会报Failed to issue method call: No such file 
or directory错误，原因是Fedora下面nfs开机自启动对应的是`nfs-server.service`，再
试一次，`ln -s '/usr/lib/systemd/system/nfs-server.service' '/etc/systemd/system/multi-user.target.wants/nfs-server.service'`成功！
